<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Soneium 评分批量查询</title>
  <style>
    :root { --radius: 10px; --border:#e5e7eb; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", Arial, sans-serif;
      color: #111827; background: #f8fafc;
    }
    .container {
      max-width: 900px; margin: 0 auto; background: #fff; border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px 20px 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .desc { color: #374151; font-size: 14px; margin-bottom: 16px; }
    textarea {
      width: 100%; min-height: 140px; resize: vertical; padding: 12px 14px;
      border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; line-height: 1.5;
    }
    .controls { display: flex; gap: 12px; align-items: center; margin: 12px 0 8px; flex-wrap: wrap; }
    button {
      border: 1px solid #d1d5db; background: #111827; color: #fff; border-radius: 8px;
      padding: 10px 16px; cursor: pointer; font-size: 14px;
    }
    button.secondary { background: #fff; color:#111827; }
    button:disabled { opacity: .65; cursor: not-allowed; }
    .stats { margin: 8px 0 12px; font-size: 14px; color: #374151; }
    .muted { color: var(--muted); }
    .table-wrap { border:1px solid var(--border); border-radius: var(--radius); overflow: hidden; background:#fff; }
    table { width:100%; border-collapse: collapse; }
    thead th {
      position: sticky; top: 0; background: #f3f4f6; font-weight: 600;
      text-align: left; font-size: 13px; color:#374151; border-bottom:1px solid var(--border); padding:10px;
    }
    thead th.sortable { cursor: pointer; user-select: none; }
    thead th .arrow { margin-left: 6px; font-size: 11px; color: var(--muted); }
    tbody td {
      border-bottom:1px solid #f3f4f6; padding:10px; font-size: 13px; vertical-align: top;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .footer { color: var(--muted); font-size: 12px; text-align: right; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Soneium 积分批量查询</h1>
    <div class="desc">将多个地址按行粘贴，每行一个地址</div>

    <textarea id="addrInput" placeholder=></textarea>

    <div class="controls">
      <button id="startBtn">开始查询</button>
      <button id="clearBtn" class="secondary">清空结果</button>
    </div>

    <div id="stats" class="stats muted">尚未开始</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-sort="total" class="sortable">总分 <span class="arrow"></span></th>
            <th data-sort="base" class="sortable">基础分 <span class="arrow"></span></th>
            <th data-sort="liquidity" class="sortable">流动性余额 <span class="arrow"></span></th>
            <th data-sort="created" class="sortable">创建时间 <span class="arrow"></span></th>
            <th data-sort="updated" class="sortable">更新时间 <span class="arrow"></span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

  <script>
    const PROXY_BASE = '/api/soneium';
    const startBtn = document.getElementById('startBtn');
    const clearBtn = document.getElementById('clearBtn');
    const addrInput = document.getElementById('addrInput');
    const tbody = document.getElementById('tbody');
    const statsEl = document.getElementById('stats');

    const sortState = { key: null, asc: true };

    function parseAddresses(raw) {
      return Array.from(new Set(
        raw.split(/\s+/).map(s => s.trim()).filter(Boolean)
      ));
    }
    function isAddress(s) {
      return /^0x[a-fA-F0-9]{40}$/.test(s);
    }
    function fmtNum(n, digits=2) {
      if (n === null || n === undefined || isNaN(n)) return '';
      const num = Number(n);
      return Number.isInteger(num) ? String(num) : num.toFixed(digits);
    }
    function fmtDate(s) {
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return s;
      return d.toLocaleString();
    }

    function rowSkeleton() {
      const tr = document.createElement('tr');
      // 仅保留 5 列
      tr.dataset.total = '';
      tr.dataset.base = '';
      tr.dataset.liquidity = '';
      tr.dataset.created = '';
      tr.dataset.updated = '';
      tr.innerHTML = `
        <td class="mono muted">查询中…</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
      `;
      return tr;
    }

    function updateRow(tr, data, error) {
      const tds = tr.querySelectorAll('td');
      if (error) {
        tds[0].textContent = '错误';
        tds[1].textContent = '-';
        tds[2].textContent = '-';
        tds[3].textContent = '-';
        tds[4].textContent = '-';
        tr.title = String(error);
        return;
      }
      const item = Array.isArray(data) ? data[0] : data;
      if (!item) {
        tds[0].textContent = '无返回';
        return;
      }
      // 显示 5 列
      tds[0].textContent = fmtNum(item.totalScore, 2);
      tds[1].textContent = fmtNum(item.baseScore, 4);
      tds[2].textContent = fmtNum(item.liquidityContributionPoints, 2); // 流动性余额 = liquidityContributionPoints
      tds[3].textContent = fmtDate(item.createdAt);
      tds[4].textContent = fmtDate(item.updatedAt);
      tr.title = JSON.stringify(item, null, 2); // 保留原始返回到 tooltip

      // dataset 供排序/统计
      const toMs = (x) => x ? Date.parse(x) : '';
      const numOrEmpty = (x) => {
        const v = Number(x);
        return Number.isFinite(v) ? String(v) : '';
      };
      tr.dataset.total = numOrEmpty(item.totalScore);
      tr.dataset.base = numOrEmpty(item.baseScore);
      tr.dataset.liquidity = numOrEmpty(item.liquidityContributionPoints);
      tr.dataset.created = toMs(item.createdAt) || '';
      tr.dataset.updated = toMs(item.updatedAt) || '';
    }

    async function fetchOne(addr) {
      const url = `${PROXY_BASE}?address=${encodeURIComponent(addr)}`;
      const res = await fetch(url, { method: 'GET' });
      const text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch (e) {
        throw new Error(`无法解析返回：${text?.slice(0,200) || '空'}`);
      }
      if (!res.ok) {
        const msg = (json && (json.message || json.error)) ? (json.message || json.error) : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return json;
    }

    function updateStats(done, total, okCount) {
      // Σ totalScore
      let sum = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        const v = parseFloat(tr.dataset.total);
        if (Number.isFinite(v)) sum += v;
      });
      statsEl.innerHTML = [
        `进度：${done}/${total}`,
        `成功 ${okCount}`,
        `总积分 Σ：${fmtNum(sum, 2)}`
      ].join(' &nbsp;|&nbsp; ');
    }

    async function runBatch(addresses, concurrency = 6) {
      statsEl.textContent = `共 ${addresses.length} 个地址，开始查询…`;
      tbody.innerHTML = '';
      const rows = addresses.map(() => {
        const tr = rowSkeleton();
        tbody.appendChild(tr);
        return tr;
      });

      let done = 0, okCount = 0;
      updateStats(done, addresses.length, okCount);

      let cursor = 0;
      async function worker() {
        while (cursor < addresses.length) {
          const idx = cursor++;
          const addr = addresses[idx];
          try {
            const data = await fetchOne(addr);
            updateRow(rows[idx], data, null);
            okCount++;
          } catch (err) {
            updateRow(rows[idx], null, err.message || String(err));
          } finally {
            done++;
            updateStats(done, addresses.length, okCount);
          }
        }
      }
      const workers = Array.from({length: Math.min(concurrency, addresses.length)}, worker);
      await Promise.all(workers);
      statsEl.innerHTML += ' &nbsp;|&nbsp; 完成 ✅';
    }

    // —— 排序 —— //
    const ths = document.querySelectorAll('thead th[data-sort]');
    ths.forEach(th => th.classList.add('sortable'));
    ths.forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.sort;
        const numericOrDateKeys = new Set(['total','base','liquidity','created','updated']);
        // 默认：数值/时间列第一次点击为降序
        const defaultAsc = !numericOrDateKeys.has(key);
        if (sortState.key === key) {
          sortState.asc = !sortState.asc;
        } else {
          sortState.key = key;
          sortState.asc = defaultAsc;
        }
        sortRows(sortState.key, sortState.asc);
        renderSortIndicators();
      });
    });

    function getVal(tr, key) {
      if (key === 'created' || key === 'updated') {
        const v = parseInt(tr.dataset[key] || '', 10);
        return Number.isFinite(v) ? v : NaN;
      }
      const v = parseFloat(tr.dataset[key]);
      return Number.isFinite(v) ? v : NaN;
    }

    function sortRows(key, asc) {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const dir = asc ? 1 : -1;
      rows.sort((a, b) => {
        const av = getVal(a, key), bv = getVal(b, key);
        const aNum = typeof av === 'number' && !isNaN(av);
        const bNum = typeof bv === 'number' && !isNaN(bv);
        if (aNum && bNum) return (av - bv) * dir;
        if (aNum && !bNum) return -1;
        if (!aNum && bNum) return 1;
        return 0;
      });
      rows.forEach(tr => tbody.appendChild(tr)); // 直接重新挂载
    }

    function renderSortIndicators() {
      ths.forEach(th => {
        const span = th.querySelector('.arrow');
        if (!span) return;
        if (th.dataset.sort === sortState.key) {
          span.textContent = sortState.asc ? '↑' : '↓';
        } else {
          span.textContent = '';
        }
      });
    }

    // —— 事件 —— //
    startBtn.addEventListener('click', async () => {
      const list = parseAddresses(addrInput.value);
      const addresses = list.filter(isAddress);
      const invalids = list.filter(x => !isAddress(x));
      if (addresses.length === 0) {
        alert('请输入至少一个有效的 0x 地址（每行一个）。');
        return;
      }
      if (invalids.length) {
        console.warn('无效地址已忽略：', invalids);
      }
      startBtn.disabled = true; clearBtn.disabled = true;
      sortState.key = null; renderSortIndicators();
      try {
        await runBatch(addresses, 6);
      } finally {
        startBtn.disabled = false; clearBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      addrInput.value = '';
      tbody.innerHTML = '';
      statsEl.textContent = '已清空';
      sortState.key = null; renderSortIndicators();
    });
  </script>
</body>
</html>
