<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Soneium 评分批量查询（含季活跃与加成任务）</title>
  <style>
    :root { --radius: 10px; --border:#e5e7eb; --muted:#6b7280; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", Arial, sans-serif; color: #111827; background: #f8fafc; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 20px 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .desc { color: #374151; font-size: 14px; margin-bottom: 16px; }
    textarea { width: 100%; min-height: 140px; resize: vertical; padding: 12px 14px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 14px; line-height: 1.5; }
    .controls { display: flex; gap: 12px; align-items: center; margin: 12px 0 8px; flex-wrap: wrap; }
    .inp { display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:#fff; color:#111827; font-size:14px; }
    .inp input { width:64px; border:none; outline:none; font-size:14px; }
    button { border: 1px solid #d1d5db; background: #111827; color: #fff; border-radius: 8px; padding: 10px 16px; cursor: pointer; font-size: 14px; }
    button.secondary { background: #fff; color:#111827; }
    button:disabled { opacity: .65; cursor: not-allowed; }
    .stats { margin: 8px 0 12px; font-size: 14px; color: #374151; }
    .muted { color: var(--muted); }
    .table-wrap { border:1px solid var(--border); border-radius: var(--radius); overflow: auto; background:#fff; }
    table { width:100%; border-collapse: collapse; min-width: 1080px; }
    thead th { position: sticky; top: 0; background: #f3f4f6; font-weight: 600; text-align: left; font-size: 13px; color:#374151; border-bottom:1px solid var(--border); padding:10px; }
    thead th.sortable { cursor: pointer; user-select: none; }
    thead th .arrow { margin-left: 6px; font-size: 11px; color: var(--muted); }
    tbody td { border-bottom:1px solid #f3f4f6; padding:10px; font-size: 13px; vertical-align: top; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .footer { color: var(--muted); font-size: 12px; text-align: right; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Soneium 积分批量查询（含季活跃与加成任务）</h1>
    <div class="desc">将多个地址按行粘贴，每行一个地址</div>

    <textarea id="addrInput" placeholder="例如：
0x09dCAe886c35E45f2545C2387725e36e18b032eB
0x3f2484D2b0f35Ee2BBc1f42c632fa885FCC9bf7F
0xe0aE1c69420953CFffdB4efeFf0Aa9BAe6a28884"></textarea>

    <div class="controls">
      <span class="inp">赛季 <input id="seasonInput" type="number" value="2" min="1" step="1"></span>
      <button id="startBtn">开始查询</button>
      <button id="clearBtn" class="secondary">清空结果</button>
      <span class="muted">全部接口均走代理 <span class="mono">/api/soneium</span></span>
    </div>

    <div id="stats" class="stats muted">尚未开始</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th data-sort="index" style="width:56px;" class="sortable"># <span class="arrow"></span></th>
            <th data-sort="address" style="min-width:360px;" class="sortable">地址 <span class="arrow"></span></th>
            <th data-sort="total" class="sortable">总分 <span class="arrow"></span></th>
            <th data-sort="base" class="sortable">基础分 <span class="arrow"></span></th>
            <th data-sort="liquidity" class="sortable">流动性积分（余额分） <span class="arrow"></span></th>
            <th data-sort="seasonScore" class="sortable">季分 <span class="arrow"></span></th>
            <th data-sort="seasonTx" class="sortable">交易次数 <span class="arrow"></span></th>
            <th data-sort="uniqueDays" class="sortable">活跃天 <span class="arrow"></span></th>
            <th data-sort="streak" class="sortable">连续天 <span class="arrow"></span></th>
            <th data-sort="bonusRatio" class="sortable">任务完成 <span class="arrow"></span></th>
            <th data-sort="created" class="sortable">创建时间 <span class="arrow"></span></th>
            <th data-sort="updated" class="sortable">更新时间 <span class="arrow"></span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">数据源：<span class="mono">/api/soneium</span>（calc/tx/bonus 统一代理）</div>
  </div>

  <script>
    // —— 配置 —— //
    const PROXY_BASE = '/api/soneium';   // 统一代理，所有请求都走它

    const startBtn = document.getElementById('startBtn');
    const clearBtn = document.getElementById('clearBtn');
    const addrInput = document.getElementById('addrInput');
    const seasonInput = document.getElementById('seasonInput');
    const tbody = document.getElementById('tbody');
    const statsEl = document.getElementById('stats');

    const sortState = { key: null, asc: true };

    // —— 工具 —— //
    function parseAddresses(raw) {
      return Array.from(new Set(
        raw.split(/\s+/).map(s => s.trim()).filter(Boolean)
      ));
    }
    function isAddress(s) { return /^0x[a-fA-F0-9]{40}$/.test(s); }
    function fmtNum(n, digits=2) {
      if (n === null || n === undefined || isNaN(n)) return '';
      const num = Number(n);
      return Number.isInteger(num) ? String(num) : num.toFixed(digits);
    }
    function fmtDate(s) {
      if (!s) return '';
      const d = new Date(s);
      if (isNaN(d)) return s;
      return d.toLocaleString();
    }
    const toMs = (x) => x ? Date.parse(x) : '';
    const numOrEmpty = (x) => {
      const v = Number(x);
      return Number.isFinite(v) ? String(v) : '';
    };

    // —— 行骨架 —— //
    function rowSkeleton(i, addr) {
      const tr = document.createElement('tr');
      tr.dataset.index = String(i);
      tr.dataset.address = addr.toLowerCase();

      tr.dataset.total = '';
      tr.dataset.base = '';
      tr.dataset.liquidity = '';
      tr.dataset.seasonScore = '';
      tr.dataset.seasonTx = '';
      tr.dataset.uniqueDays = '';
      tr.dataset.streak = '';
      tr.dataset.bonusRatio = '';
      tr.dataset.created = '';
      tr.dataset.updated = '';

      tr.innerHTML = `
        <td class="mono">${i+1}</td>
        <td class="mono">${addr}</td>
        <td class="mono muted">查询中…</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted" title="—">-</td>
        <td class="mono muted">-</td>
        <td class="mono muted">-</td>
      `;
      return tr;
    }

    // —— 写入：calculator（容错字段名 + 支持返回数字0） —— //
    function updateRowBase(tr, item) {
      const tds = tr.querySelectorAll('td');

      // 情况 A：后端返回数字（无该季 -> 0）
      if (typeof item === 'number') {
        tds[2].textContent = fmtNum(item, 0); // 总分=0
        tds[3].textContent = '-';
        tds[4].textContent = '-';
        tds[10].textContent = '';
        tds[11].textContent = '';
        tr.title = String(item);
        tr.dataset.total = numOrEmpty(item); // "0"
        tr.dataset.base = '';
        tr.dataset.liquidity = '';
        tr.dataset.created = '';
        tr.dataset.updated = '';
        return;
      }

      // 情况 B：对象
      if (!item || typeof item !== 'object') {
        tds[2].textContent = '无返回';
        return;
      }

      // 兼容不同字段名
      const total = item.totalScore ?? item.score ?? item.points;
      const base  = item.baseScore ?? item.base ?? item.basePoints;
      const liq   = item.liquidityContributionPoints
                 ?? item.allTimeLiquidityScore
                 ?? item.tvl?.allTimeLiquidityScore
                 ?? item.tvl?.scoreContributionUsd;

      // 时间容错
      const createdAt = item.createdAt
                     ?? (item.scoreCreatedAt ? new Date(item.scoreCreatedAt).toISOString() : undefined);
      const updatedAt = item.updatedAt
                     ?? (item.scoreLastUpdated ? new Date(item.scoreLastUpdated).toISOString() : undefined);

      tds[2].textContent = fmtNum(total, 2);
      tds[3].textContent = base != null ? fmtNum(base, 4) : '';
      tds[4].textContent = liq  != null ? fmtNum(liq, 2)  : '';
      tds[10].textContent = fmtDate(createdAt);
      tds[11].textContent = fmtDate(updatedAt);

      tr.title = (item && typeof item === 'object') ? JSON.stringify(item, null, 2) : String(item);
      tr.dataset.total = numOrEmpty(total);
      tr.dataset.base = numOrEmpty(base);
      tr.dataset.liquidity = numOrEmpty(liq);
      tr.dataset.created = createdAt ? Date.parse(createdAt) : '';
      tr.dataset.updated = updatedAt ? Date.parse(updatedAt) : '';
    }

    // —— 写入：季活跃（tx-per-season） —— //
    function updateRowSeason(tr, item) {
      const tds = tr.querySelectorAll('td');
      if (!item || typeof item !== 'object') return;
      tds[5].textContent = fmtNum(item.score, 2);
      tds[6].textContent = fmtNum(item.totalTransactions, 0);
      tds[7].textContent = fmtNum(item.uniqueDays, 0);
      tds[8].textContent = fmtNum(item.streak, 0);

      tr.dataset.seasonScore = numOrEmpty(item.score);
      tr.dataset.seasonTx    = numOrEmpty(item.totalTransactions);
      tr.dataset.uniqueDays  = numOrEmpty(item.uniqueDays);
      tr.dataset.streak      = numOrEmpty(item.streak);
    }

    // —— 写入：加成任务（bonus-dapp） —— //
    function updateRowBonus(tr, list) {
      const tds = tr.querySelectorAll('td');
      if (!Array.isArray(list)) return;

      const totalWeeks = list.length;
      let doneWeeks = 0;
      const lines = [];

      for (const w of list) {
        const weekId = `W${w.week}-${w.id}`;
        const parts = [];
        let weekDone = true;
        if (Array.isArray(w.quests)) {
          for (const q of w.quests) {
            const ok = Boolean(q.isDone || (Number(q.completed) >= Number(q.required)));
            parts.push(`${q.description}：${q.completed}/${q.required} ${ok ? '✅' : '❌'}`);
            if (!ok) weekDone = false;
          }
        } else {
          weekDone = false;
        }
        if (weekDone) doneWeeks++;
        lines.push(`${weekId}（${w.name}，加成 ${w.questsBonus}）\n - ${parts.join('\n - ')}`);
      }

      const ratioText = totalWeeks ? `${doneWeeks}/${totalWeeks}` : '-';
      tds[9].textContent = ratioText;
      tds[9].title = lines.length ? lines.join('\n\n') : '—';

      const ratio = (totalWeeks > 0) ? (doneWeeks / totalWeeks) : 0;
      tr.dataset.bonusRatio = String(ratio);
    }

    // —— 请求封装（统一走 /api/soneium） —— //
    async function fetchBase(addr, season) {
      // 现在 calc 也带 season，与 tx 同步；后端若无该季，则返回数字 0
      const url = `${PROXY_BASE}?address=${encodeURIComponent(addr)}&season=${encodeURIComponent(season)}`; // 默认 type=calc
      const r = await fetch(url);
      const t = await r.text();
      let j; try { j = JSON.parse(t); } catch {
        // 兼容后端直接返回数字 0 的情况（是合法 JSON，但保险起见）
        if (t.trim() === '0') return 0;
        throw new Error(`calculator 解析失败：${t?.slice(0,200) || '空'}`);
      }
      if (!r.ok) throw new Error(j?.message || `HTTP ${r.status}`);
      // 你后端已经把 calc 聚合为“对象或数字0”，这里原样返回
      return j;
    }

    async function fetchSeason(addr, season) {
      const url = `${PROXY_BASE}?type=tx&address=${encodeURIComponent(addr)}&season=${encodeURIComponent(season)}`;
      const r = await fetch(url);
      const t = await r.text();
      let j; try { j = JSON.parse(t); } catch { throw new Error(`tx-per-season 解析失败：${t?.slice(0,200)}`); }
      if (!r.ok) throw new Error(j?.message || `HTTP ${r.status}`);
      return j;
    }

    async function fetchBonus(addr) {
      const url = `${PROXY_BASE}?type=bonus&address=${encodeURIComponent(addr)}`;
      const r = await fetch(url);
      const t = await r.text();
      let j; try { j = JSON.parse(t); } catch { throw new Error(`bonus-dapp 解析失败：${t?.slice(0,200)}`); }
      if (!r.ok) throw new Error(j?.message || `HTTP ${r.status}`);
      return j; // 数组
    }

    function updateStats(done, total, okCount) {
      // Σ totalScore（calculator）
      let sum = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        const v = parseFloat(tr.dataset.total);
        if (Number.isFinite(v)) sum += v;
      });
      statsEl.innerHTML = [
        `进度：${done}/${total}`,
        `成功 ${okCount}`,
        `总积分 Σ：${fmtNum(sum, 2)}`
      ].join(' &nbsp;|&nbsp; ');
    }

    // —— 并发批量 —— //
    async function runBatch(addresses, season, concurrency = 6) {
      statsEl.textContent = `共 ${addresses.length} 个地址，开始查询（赛季 ${season}）…`;
      tbody.innerHTML = '';
      const rows = addresses.map((addr, i) => {
        const tr = rowSkeleton(i, addr);
        tbody.appendChild(tr);
        return tr;
      });

      let done = 0, okCount = 0;
      updateStats(done, addresses.length, okCount);

      let cursor = 0;
      async function worker() {
        while (cursor < addresses.length) {
          const idx = cursor++;
          const addr = addresses[idx];
          const tr = rows[idx];

          try {
            const [baseRes, seasonRes, bonusRes] = await Promise.allSettled([
              fetchBase(addr, season),
              fetchSeason(addr, season),
              fetchBonus(addr)
            ]);

            if (baseRes.status === 'fulfilled') {
              updateRowBase(tr, baseRes.value);
            } else {
              updateRowBase(tr, null);
              tr.querySelectorAll('td')[2].textContent = '错误';
              tr.querySelectorAll('td')[2].title = baseRes.reason?.message || String(baseRes.reason || '');
            }

            if (seasonRes.status === 'fulfilled') {
              updateRowSeason(tr, seasonRes.value);
            } else {
              tr.querySelectorAll('td')[5].textContent = '-';
              tr.querySelectorAll('td')[5].title = seasonRes.reason?.message || String(seasonRes.reason || '');
            }

            if (bonusRes.status === 'fulfilled') {
              updateRowBonus(tr, bonusRes.value);
            } else {
              tr.querySelectorAll('td')[9].textContent = '-';
              tr.querySelectorAll('td')[9].title = bonusRes.reason?.message || String(bonusRes.reason || '');
            }

            if (baseRes.status === 'fulfilled') okCount++;

          } catch (err) {
            const tds = tr.querySelectorAll('td');
            tds[2].textContent = '错误';
            tr.title = err?.message || String(err || '');
          } finally {
            done++;
            updateStats(done, addresses.length, okCount);
          }
        }
      }
      const workers = Array.from({length: Math.min(concurrency, addresses.length)}, worker);
      await Promise.all(workers);
      statsEl.innerHTML += ' &nbsp;|&nbsp; 完成 ✅';
    }

    // —— 排序 —— //
    const ths = document.querySelectorAll('thead th[data-sort]');
    ths.forEach(th => th.classList.add('sortable'));
    const numericOrDateKeys = new Set(['total','base','liquidity','seasonScore','seasonTx','uniqueDays','streak','bonusRatio','created','updated']);

    ths.forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.sort;
        const defaultAsc = (key === 'address' || key === 'index') ? true : !numericOrDateKeys.has(key);
        if (sortState.key === key) {
          sortState.asc = !sortState.asc;
        } else {
          sortState.key = key;
          sortState.asc = defaultAsc;
        }
        sortRows(sortState.key, sortState.asc);
        renderSortIndicators();
      });
    });

    function getVal(tr, key) {
      const ds = tr.dataset;
      if (key === 'address') return (ds.address || '');
      if (key === 'index')   return parseInt(ds.index || '', 10);
      if (key === 'created' || key === 'updated') return parseInt(ds[key] || '', 10);
      const v = parseFloat(ds[key]);
      return Number.isFinite(v) ? v : NaN;
    }

    function sortRows(key, asc) {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const dir = asc ? 1 : -1;
      rows.sort((a, b) => {
        const av = getVal(a, key), bv = getVal(b, key);
        const aNum = typeof av === 'number' && !isNaN(av);
        const bNum = typeof bv === 'number' && !isNaN(bv);
        if (aNum && bNum) return (av - bv) * dir;
        if (aNum && !bNum) return -1;
        if (!aNum && bNum) return 1;
        const as = String(av || ''), bs = String(bv || '');
        return as.localeCompare(bs) * dir;
      });
      rows.forEach((tr, i) => {
        tbody.appendChild(tr);
        const tdIndex = tr.querySelector('td');
        if (tdIndex) tdIndex.textContent = String(i + 1);
      });
    }

    function renderSortIndicators() {
      const heads = document.querySelectorAll('thead th[data-sort]');
      heads.forEach(th => {
        const span = th.querySelector('.arrow');
        if (!span) return;
        if (th.dataset.sort === sortState.key) {
          span.textContent = sortState.asc ? '↑' : '↓';
        } else {
          span.textContent = '';
        }
      });
    }

    // —— 事件 —— //
    startBtn.addEventListener('click', async () => {
      const list = parseAddresses(addrInput.value);
      const addresses = list.filter(isAddress);
      const invalids = list.filter(x => !isAddress(x));
      if (addresses.length === 0) {
        alert('请输入至少一个有效的 0x 地址（每行一个）。');
        return;
      }
      if (invalids.length) {
        console.warn('无效地址已忽略：', invalids);
      }
      startBtn.disabled = true; clearBtn.disabled = true;
      sortState.key = null; renderSortIndicators();
      try {
        const season = parseInt(seasonInput.value || '2', 10) || 2; // 默认 2
        await runBatch(addresses, season, 6);
      } finally {
        startBtn.disabled = false; clearBtn.disabled = false;
      }
    });

    clearBtn.addEventListener('click', () => {
      addrInput.value = '';
      tbody.innerHTML = '';
      statsEl.textContent = '已清空';
      sortState.key = null; renderSortIndicators();
    });
  </script>
</body>
</html>
